import{d as M,k as C,a as N,al as D,am as q,an as S,ao as Q,q as g,ap as W,l as G,aq as m,a3 as J,ar as $,as as H,at as F,au as X,av as Y,aw as Z,ax as V}from"./eo-dash.CLSNzb4v.js";import{u as j,g as ee,a as A,e as te,b as ae,s as O,c as re,p as ne,d as oe,f as _,h as se,i as ie}from"./async-739T1skh.Bpe3aqa4.js";import{t as I}from"./item.Bx-rtsOD.js";async function le({links:e,jsonformValue:t,specUrl:r,customEndpointsHandler:a,jsonformSchema:o,selectedStac:s,isPolling:u,jobs:f,enableCompare:c=!1}){if(!r||!e)return[null,null];const i=await g.get(r).then(h=>h.data),n={},[d,l]=O(e,"service",void 0),p=a&&t&&await a({jsonformSchema:o,jsonformValue:t,links:l,selectedStac:s,isPolling:u,jobs:f,enableCompare:c});if(p&&p.length)return i.data.values=p,[i,n];const y=d.filter(h=>h.rel==="service"),v=y.filter(h=>h.type==="application/json");if(v.length>=2){for(const h of v??[])switch(h.type){case void 0:continue;case"application/json":n[h.id]=await g.get(m.render(h.href,{...t??{}})).then(x=>x.data),i.data&&(i.data.values={...i.data&&"values"in i.data&&typeof i.data.values=="object"?i.data.values:{},[h.id]:n[h.id]});break}return[i,n]}try{e:for(const h of y??[])switch(h.type){case void 0:continue;case"application/json":await ce(i,{url:h.href,jsonformValue:t,link:h,flatstyleUrl:h["eox:flatstyle"],jsonformSchema:o});break e;case"text/csv":await ue(i,{url:h.href,jsonformValue:t,flatstyleUrl:h["eox:flatstyle"]});break e}}catch(h){console.error("[eodash] Error while injecting Vega data",h)}return[i,n]}async function ce(e,{url:t,jsonformValue:r,link:a,flatstyleUrl:o,jsonformSchema:s}){var u;if(e.data){if(a.method=="GET"){const f=(u=s==null?void 0:s.options)==null?void 0:u.multiQuery,c=Object.keys(r??{}).filter(n=>Array.isArray(f)?f.includes(n):f===n);if(c.length>0&&r){const n=[];for(const d of c)if(Array.isArray(r[d]))for(const l of r[d]){const p=await L(t,{...r,[d]:l},o);n.push(await g.get(p).then(y=>y.data))}else{const l=await L(t,r,o);n.push(await g.get(l).then(p=>p.data))}return e.data.values=n.flat(),e}const i=await L(t,r,o);e.data.values=await g.get(i).then(n=>n.data)}else if(a.method=="POST"){if(!a.body)return console.error("[eodash] Inline data POST request requires a body template"),e;const f=await g.get(a.body,{responseType:"text"}).then(i=>i.data),c=JSON.parse(m.render(f,{...r??{}}));e.data.values=await g.post(t,c).then(i=>i.data)}return e}}async function ue(e,{url:t,jsonformValue:r,flatstyleUrl:a}){if(!e.data)return;const o=await L(t,r,a);return e.data.url=o,e}async function L(e,t,r){let a={};return r&&(a=await g.get(r).then(o=>o.data)),m.render(e,{...t??{},...a})}async function de({links:e,jsonformValue:t,layerId:r,projection:a}){if(!e)return;const[o]=O(e,"service","image/tiff");if(!o.length)return;let s=[],u="";for(const c of o??[])s.push(m.render(c.href,{...t??{}}));return await Promise.all(o.map(c=>re(c,r,s,a,u))).then(c=>c.filter(i=>!!i))}function fe(e,t,r){if(!e)return;const a=e.filter(s=>s.rel==="service"&&s.type==="image/png"),o=[];for(const s of a)o.push({type:"Image",properties:{id:s.id+"_process",title:"Results "+s.id},source:{type:"ImageStatic",imageExtent:r,url:m.render(s.href,{...t??{}})}});return o}async function pe(e,t,r){if(!e)return;const a=[],o=e.filter(u=>u.rel==="service"&&u.type==="application/geo+json");if(!o.length)return a;let s=null;for(const u of o){"eox:flatstyle"in(u??{})&&(s=await g.get(u["eox:flatstyle"]).then(n=>n.data));let f,c;if(s){const n=$(r??"",s);f=n.layerConfig,c=n.style}const i={type:"Vector",source:{type:"Vector",url:m.render(u.href,{...t??{}}),format:"GeoJSON"},properties:{id:u.id+"_process",title:"Results "+r,...f&&{...f}},...c&&{style:c}};a.push(i)}return a}async function he({links:e,jsonformValue:t,layerId:r,projection:a,origBbox:o,isPolling:s,selectedStac:u,jsonformSchema:f,jobs:c,customLayersHandler:i,enableCompare:n=!1}){if(!e)return[];const d=[],[l,p]=O(e,"service",void 0);if(i&&t&&u&&f&&p.length>0){const w=await i({jsonformValue:t,links:p,selectedStac:u,isPolling:s,jsonformSchema:f,jobs:c,enableCompare:n});w.length&&d.push(...w)}const y=await pe(l,t,r),v=fe(l,t,o),h=await de({links:l,jsonformValue:t,layerId:r,projection:a});return d.push(...y??[],...v??[],...h??[]),d}async function ye(e,t,r=!1){const a=e.find(f=>f.rel==="service"&&f.type=="application/json; profile=collection"&&f.endpoint==="STAC");if(!a)return;let o=m.render(a.href,{...t??{}});J.value&&(J.value=!1);const s=N();await(r?s.loadSelectedCompareSTAC:s.loadSelectedSTAC)(o,!0)}async function ve({links:e,jsonformValue:t,isPolling:r,selectedStac:a,jobs:o,enableCompare:s=!1}){if(!r)return;const u=e.filter(c=>c.rel==="service"&&c.endpoint==="eoxhub_workspaces"),f=[];for(const c of u){const i=await g.get(c.body,{responseType:"text"}).then(l=>l.data),n=JSON.parse(m.render(i,{...t??{}})),d=s?S:C;try{const l=await g.post(c.href,n,{headers:{"Content-Type":"application/json"}}),p=JSON.parse(localStorage.getItem(d.value)||"[]");p.push(l.headers.location),localStorage.setItem(d.value,JSON.stringify(p));const y=await ne({jobs:o,processUrl:l.headers.location,isPolling:r,enableCompare:s}).then(v=>oe(v)).catch(v=>(v instanceof Error?console.error("Polling failed:",v.message):console.error("Unknown error occurred during polling:",v),[]));await _(o,d.value),f.push(...await se(y,c,a))}catch(l){await _(o,d.value),l instanceof Error?console.error("Error sending POST request:",l.message):console.error("Unknown error occurred:",l)}}return f}const ge=we([ve]);function we(e){return async t=>await Promise.all(e.map(r=>r(t))).then(r=>{const a=[];for(const o of r)a.push(...(o==null?void 0:o.filter(be))??[]);return a})}function be(e){return!!e&&!!e.type&&(!!e.source||!!e.layers)}async function me({links:e,jsonformValue:t,jsonformSchema:r,selectedStac:a,enableCompare:o=!1}){const s=e.find(l=>l.rel==="service"&&l.endpoint==="sentinelhub");if(!s)return;const u=await xe(a,o?H.value:F.value);if(!u){console.error("[eodash] evalscript link for sentinel hub not found in indicator",u);return}if(!s)return;const f=s.href,c=A(r),i=t[c],n=await ke();if(!n){console.error("[eodash] Error while fetching bearer token from sentinel hub");return}const d=ie(a.extent.temporal.interval[0],[t.start_date,t.end_date],t.distribution);return await Promise.all(d.map(([l,p])=>Pe({url:f,bearer:n,bbox:i,from:p,to:l,exampleLink:u}).catch(y=>console.error("[eodash] Error while fetching data from sentinel hub endpoint:",y)))).then(l=>l.flat().map(p=>p.outputs.data))}async function ke(e,t){{console.error("[eodash] Error (sentinelhub): client id or secret not found");return}}async function Pe({url:e,bearer:t,bbox:r,from:a,to:o,timeout:s=2e4,exampleLink:u}){if(!u){console.error("[eodash] Error (sentinelhub): example link not found in indicator");return}if(!r){console.error("[eodash] Error (sentinelhub): bbox not found");return}if(!a||!o||new Date(a)>new Date(o)){console.error("[eodash] Error (sentinelhub): time range is faulty or not found",a,o);return}const f=await g.get(u.href,{responseType:"text"}).then(n=>n.data);if(!f||f.error){console.error("[eodash] Error (sentinelhub): evalscript not found",f);return}const c={input:{bounds:{bbox:r},data:[{dataFilter:{},type:u.dataId}]},aggregation:{evalscript:f,timeRange:{from:a,to:o},aggregationInterval:{of:"P1D"},width:100,height:100},calculations:{default:{}}},i={headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},params:{credentials:"same-origin"},timeout:s};return await g.post(e,c,i).then(n=>{const d=n.data.data;return d.forEach(l=>{l.outputs.data.date=a}),d}).catch(n=>{var d,l;if(((d=n.response)==null?void 0:d.status)===401){console.error("[eodash] Error (sentinelhub): bearer token expired, please try again"),sessionStorage.removeItem("sentinelhub_token"),sessionStorage.removeItem("sentinelhub_token_time");return}return console.error("[eodash] Error (sentinelhub): error while fetching data from sentinel hub",(l=n.response)==null?void 0:l.data),[]})}async function xe(e,t){const r=e.links.find(a=>a.rel==="example"&&a.title==="evalscript");if(r)return r;for(const a of X(e,t)){const o=g.get(a).then(s=>s.data.links.find(u=>u.rel==="example"&&u.title==="evalscript"));if(o)return o}}async function Ce({links:e,jsonformSchema:t,jsonformValue:r,selectedStac:a,enableCompare:o=!1}){const s=e.find(n=>n.rel==="service"&&(n.endpoint==="veda"||n.endpoint==="veda_stac"));if(!s)return;const u=s==null?void 0:s.href,f=A(t),c=JSON.parse(r[f]),i=await Le(a,o?H.value:F.value,s);return await Promise.all(i.map(({endpoint:n,datetime:d})=>{const l=new URL(u),p=s.endpoint==="veda_stac"?"ids":"url";return l.searchParams.set(p,n),g.post(l.toString(),{type:"Feature",properties:{},geometry:c}).then(y=>{const v=y.data.properties.statistics;return v.date=d,v}).catch(y=>console.error("[eodash] Error while fetching data from veda endpoint:",y))}))}async function Le(e,t,r){const a=e.links.filter(i=>i.rel=="child"),o=[];a.length?o.push(...await Promise.all(a.map(i=>g.get(I(i.href,t)).then(n=>n.data).then(async n=>{const d=Object.values(n.assets??{}).find(l=>{var p;return l.type==="application/vnd.apache.parquet"&&((p=l.roles)==null?void 0:p.includes("collection-mirror"))});if(d){const l=I(d.href,I(i.href,t));await Y(l).then(p=>{n.links.push(...Z(p))})}return n})))):o.push(e);const s=[];for(const i of o){const n=V(i.links),d=i.links.filter(l=>l.rel=="item");s.push(...d.map(l=>({endpoint:r.endpoint==="veda_stac"?l.id:l.cog_href,datetime:l[n]})))}s.sort((i,n)=>new Date(i.datetime).getTime()-new Date(n.datetime).getTime());const u=50;if(s.length<=u)return s;const f=s.length,c=[];for(let i=0;i<u;i++){const n=Math.floor(i*(f-1)/(u-1));c.push(s[n])}return c}const Te=Ie([me,Ce]);function Ie(e){return async t=>{for(const r of e){const a=await r(t);if(G.debug("Custom endpoint data:",a,"for callback:",r.name,"inputs:",t),!(!a||!a.length||a.some(s=>!s)))return a}return null}}async function De({selectedStac:e,jsonformEl:t,jsonformSchema:r,chartSpec:a,isProcessed:o,processResults:s,loading:u,isPolling:f,enableCompare:c}){var d,l,p,y,v,h;const i=c?!!q.value:!!Q.value;let n=null;if((d=e.value)!=null&&d["eodash:jsonform"]&&(n=await g.get(e.value["eodash:jsonform"]).then(w=>w.data)),!n&&i){r.value=null;return}Ae({loading:u,isProcessed:o,chartSpec:a,jsonformSchema:r,isPolling:f,processResults:s}),await((l=t.value)==null?void 0:l.editor.destroy()),n&&((h=(v=(y=(p=n.properties)==null?void 0:p.feature)==null?void 0:y.options)==null?void 0:v.drawtools)!=null&&h.layerId&&await Se({jsonformSchema:r,newLayers:await W()}),c&&(n=j(n)),r.value=n)}async function Se({jsonformSchema:e,newLayers:t}){var o,s,u;const r=e.value;if(!r)return;const a=ee(r);if(a&&t&&((u=(s=(o=r==null?void 0:r.properties[a])==null?void 0:o.options)==null?void 0:s.drawtools)!=null&&u.layerId)){let f=t;t.layers&&Array.isArray(t.layers)&&(f=t.layers);const c=r.properties[a].options.drawtools.layerId.split(";:;")[0];let i=null;const n=d=>{var l,p;if(d){for(const y of d)if(y.layers)n(y);else if((p=(l=y.properties)==null?void 0:l.id)!=null&&p.startsWith(c)){i=y.properties.id;break}}};if(n(f),i)r.properties.feature.options.drawtools.layerId=i,e.value=null,await new Promise(d=>setTimeout(d,0)),e.value=r;else throw new Error(`Could not find matching layer for processing form with id: ${c}`)}}async function Je({loading:e,selectedStac:t,jsonformEl:r,jsonformSchema:a,chartSpec:o,chartData:s,isPolling:u,processResults:f,mapElement:c,jobs:i}){var n,d,l,p,y,v,h,w,x,E,U;if(!(!r.value||!a.value||!t.value)){G.debug("Processing..."),e.value=!0;try{const k=(d=(n=t.value)==null?void 0:n.links)==null?void 0:d.filter(b=>b.rel==="service"),B=A(a.value),P=(l=r.value)==null?void 0:l.value;te(P,a.value);const R=P[B],z=(p=t.value)==null?void 0:p["eodash:vegadefinition"],K=((y=t.value)==null?void 0:y.id)??"";[o.value,s.value]=await le({links:k,jsonformValue:{...P??{}},jsonformSchema:a.value,enableCompare:(c==null?void 0:c.id)==="compare",selectedStac:t.value,specUrl:z,isPolling:u,jobs:i,customEndpointsHandler:Te}),Object.keys(s.value??{}).length&&f.value.push(s.value),(w=(h=(v=o.value)==null?void 0:v.data)==null?void 0:h.values)!=null&&w.length&&f.value.push((x=o.value)==null?void 0:x.data.values),o.value&&!("background"in o.value)&&(o.value.background="transparent"),await ye(k,P,(c==null?void 0:c.id)==="compare");const T=await he({isPolling:u,links:k,jsonformValue:{...P??{}},jsonformSchema:a.value,selectedStac:t.value,enableCompare:(c==null?void 0:c.id)==="compare",layerId:K,origBbox:R,jobs:i,customLayersHandler:ge,projection:(E=t.value["eodash:mapProjection"])==null?void 0:E.name});if(T.length)for(const b of T)b.type==="WebGLTile"&&((U=b.source)==null?void 0:U.type)==="GeoTIFF"?f.value.push(...b.source.sources??[]):b.source&&"url"in b.source&&f.value.push(b.source.url);ae(c,T),e.value=!1}catch(k){throw console.error("[eodash] Error while running process:",k),e.value=!1,k}}}function Ae({loading:e,isProcessed:t,chartSpec:r,jsonformSchema:a,processResults:o,isPolling:s}){e.value=!1,t.value=!1,s.value=!1,r.value=null,o.value=[],a.value=null}const _e=e=>{var o,s,u,f,c,i;const t=(o=e.target)==null?void 0:o.spec;if(!t||!((u=(s=e.detail)==null?void 0:s.item)!=null&&u.datum)||!((c=(f=e.detail)==null?void 0:f.item)!=null&&c.datum.datum))return;const r=Object.keys(t.encoding??{}).find(n=>{var d;return((d=t.encoding)==null?void 0:d[n].type)==="temporal"});if(!r)return;const a=(i=t.encoding)==null?void 0:i[r].field;if(a)try{const n=e.detail.item;let d="";n.datum&&n.datum.datum?d=n.datum.datum[a]:d=n.datum[a];const l=new Date(d);M.value=l.toISOString()}catch(n){console.warn("[eodash] Error while setting datetime from eox-chart:",n)}},Ne=()=>{var r,a;C.value||(C.value=new URLSearchParams(window.location.search).get("indicator")??"");const e=N(),t=(r=e.stac)==null?void 0:r.find(o=>D(o)===C.value);if(e.loadSelectedSTAC(t==null?void 0:t.href),q.value)if(S.value){const o=(a=e.stac)==null?void 0:a.find(s=>D(s)===S.value);e.loadSelectedCompareSTAC(o==null?void 0:o.href).catch(s=>{console.error("[eodash] Error loading compare STAC:",s)})}else e.resetSelectedCompareSTAC()};export{Je as h,De as i,Ne as l,_e as o,Se as u};
