import"./main.Db7Y8C7t.js";import"./index.C_LCnMPw.js";import{Z as w,s as G,a as I,$ as se,a0 as ae,d as U,h as V,l as N,a1 as ie,a2 as le,a3 as ne,a4 as ue,i as ce,a5 as pe,a6 as D,W as Z,a7 as H}from"./eo-dash.CbtluJu3.js";import{p as L,av as R,h as A,v as Y,c as ye,o as ve,j as z,N as W,k as q,x as E,q as fe}from"./framework.D-wes4Dd.js";import"./addCommonStyleSheet.mvVW20o2.js";import"./Group.TOLTOuRh.js";import"./extent.Dy7YBqBe.js";import"./WMTS.wEVSTEUd.js";import"./GeoJSON.CRUW1A8G.js";import"./getElement.CdRlZPdn.js";import"./WKT.ChjBEC7E.js";import"./commonjsHelpers.BosuxZz1.js";import"./item.koN_VtZd.js";const $=async(e,a,n)=>{N.debug("Creating layers config",e,a,n);const r=[],s={type:"Group",properties:{id:"AnalysisGroup",title:"Data Layers",layerControlExpand:!0},layers:[]};for(const i of a){let y;n?y=await i.createLayersJson(new Date(n)):y=await i.createLayersJson(),y.forEach(l=>{l.properties.layerControlExpand=!0,l.properties.layerControlToolsExpand=!0}),s.layers.push(...y)}r.push(s);const u=await H.getIndicatorLayers(e),d=H.getObservationPointsLayer(a);d&&s.layers.unshift(d);const c={type:"Group",properties:{id:"BaseLayersGroup",title:"Base Layers"},layers:[]},t=u.filter(i=>i.properties.group==="baselayer");if(t.length){let i=0,y=0;for(let l=0;l<t.length;l++){const f=t[l];"visible"in f.properties||(f.properties.visible=!1),f.properties.visible&&(i++,y=l)}i===0&&(t[0].properties.visible=!0),i>0&&t.forEach((l,f)=>{f!==y?l.properties.visible=!1:l.properties.visible=!0}),c.layers.push(...t),c.layers.forEach(l=>{l.properties.layerControlExclusive=!0})}else c.layers.push({type:"Tile",properties:{id:"osm",title:"Background",layerControlExclusive:!0},source:{type:"OSM"}});c.layers.length&&r.push(c);const g={type:"Group",properties:{id:"OverlayGroup",title:"Overlay Layers"},layers:[]},p=u.filter(i=>i.properties.group==="overlay");return p.length&&(g.layers.push(...p),r.unshift(g)),r};let J=null;const de=(e,a)=>{const n=r=>{var c;const s=r.map,u=(c=e.value)==null?void 0:c.lonLatCenter,d=s==null?void 0:s.getView().getZoom();u&&!Number.isNaN(u[0])&&!Number.isNaN(u[1])&&!Number.isNaN(d)&&(a.value=[u[0],u[1],d])};Y(()=>{var r,s;(s=(r=e.value)==null?void 0:r.map)==null||s.on("moveend",n)}),E(()=>{var r,s;(s=(r=e.value)==null?void 0:r.map)==null||s.un("moveend",n)})},K=(e,a,n,r,s,u,d)=>{N.debug("InitMap",e.value,a.value,n.values,r.value);const c=fe([a,r],async([t,g],[p,i])=>{var y,l,f,M,O,_,h,x,P,v,m,C,B,F,S,j;if(t){N.debug("Selected Indicator watch triggered",t,g),((y=e==null?void 0:e.value)==null?void 0:y.id)==="main"&&J!==null&&((l=e==null?void 0:e.value)==null||l.map.setView(J),J=null);let b=[];const ee=(t==null?void 0:t.id)===(p==null?void 0:p.id)&&g!==i,{selectedCompareStac:oe}=G(I());if(((f=e==null?void 0:e.value)==null?void 0:f.id)==="main"?await pe(t):oe.value!==null&&(J=((M=e==null?void 0:e.value)==null?void 0:M.map.getView())??null,e.value.sync=u.value),ee){b=await $(t,n,g),N.debug("Assigned layers after changing time only",JSON.parse(JSON.stringify(b))),s.value=b,D(((O=e.value)==null?void 0:O.id)==="compare"?"compareTime:updated":"time:updated",e.value,b);return}b=await $(t,n,r.value);let T=null;const k=(h=(_=t==null?void 0:t.extent)==null?void 0:_.temporal)==null?void 0:h.interval;if(k&&k.length>0&&k[0].length>1&&(T=new Date(k[0][1]),N.debug("Indicator load: found stac extent, setting time to latest value",T)),T!==null&&T.toISOString()!==r.value&&!Z.value&&(r.value=T.toISOString()),d&&((x=e==null?void 0:e.value)==null?void 0:x.id)==="main"&&(P=t.extent)!=null&&P.spatial.bbox&&!(Z.value&&((v=w.value)!=null&&v[0])&&((m=w.value)!=null&&m[1]))){const o=(C=t.extent)==null?void 0:C.spatial.bbox[0],re=[(o==null?void 0:o[0])>-180?o==null?void 0:o[0]:-180,(o==null?void 0:o[1])>-90?o==null?void 0:o[1]:-90,(o==null?void 0:o[2])<180?o==null?void 0:o[2]:180,(o==null?void 0:o[3])<90?o==null?void 0:o[3]:90],te=(S=e.value)==null?void 0:S.transformExtent(re,"EPSG:4326",(F=(B=e.value)==null?void 0:B.map)==null?void 0:F.getView().getProjection());e.value.zoomExtent=te}N.debug("Assigned layers",JSON.parse(JSON.stringify(b))),s.value=b,await D(((j=e.value)==null?void 0:j.id)==="compare"?"compareLayers:updated":"layers:updated",e.value,s.value)}},{immediate:!0});E(()=>{c()})},Q=(e,a)=>{ie(async(n,r)=>{if(n.includes("compare"))return;const s=[];for(const u of e)s.push(...await u.getToolTipProperties());a.value=s,N.debug("Updated tooltip properties",a.value)})};function ge(e){return 3*e*e-2*e*e*e}const he=[".enabled"],xe=[".center",".zoom",".layers"],Ce=[".propertyTransform"],be=[".layers"],we=[".propertyTransform"];var X;const Ae={__name:"index",props:{enableCompare:{type:Boolean,default:!1},center:{type:Array,default:()=>{var e,a;return[((e=w.value)==null?void 0:e[0])??15,((a=w.value)==null?void 0:a[1])??48]}},zoom:{type:Number,default:((X=w.value)==null?void 0:X[2])??4},zoomToExtent:{type:Boolean,default:!0}},setup(e){var _;const a=e,n=L([]),r=L([]),s={Attribution:{collapsible:!0}},u=R(a.center),d=R(((_=w.value)==null?void 0:_[2])??a.zoom),c=L([{type:"Tile",source:{type:"OSM"},properties:{id:"osm",title:"Background"}}]),t=L([{type:"Tile",source:{type:"OSM"},properties:{id:"osm",title:"Background"}}]),g={duration:1200,easing:ge},p=L(null),i=L(null),{selectedCompareStac:y}=G(I()),l=A(()=>a.enableCompare&&y.value?"":"first");de(p,w),Y(()=>{const{selectedCompareStac:h,selectedStac:x}=G(I());se.value=p.value,a.enableCompare&&(ae.value=i.value),a.enableCompare&&(K(i,h,ce,U,t,p,!1),Q(V,r)),K(p,x,V,U,c,i,a.zoomToExtent)}),Q(V,n);const f=A(()=>({visibility:n.value.length?"visible":"hidden"})),M=A(()=>({visibility:r.value.length?"visible":"hidden"})),O=h=>{const x=h==="main"?n:r,P=h=="main"?ne:ue;return v=>{const m=JSON.parse(le.render(JSON.stringify(x.value),{...P.value??{}})),C=m==null?void 0:m.find(B=>B.id===v.key);if(C)return typeof v.value=="object"&&(v.value=JSON.stringify(v.value)),isNaN(Number(v.value))||(v.value=Number(v.value).toFixed(4).toString()),{key:C.title||C.id,value:v.value+" "+(C.appendix||"")}}};return(h,x)=>(ve(),ye("eox-map-compare",{class:"fill-height fill-width overflow-none",".enabled":l.value},[z("eox-map",{class:"fill-height fill-width overflow-none",slot:"first",ref_key:"eoxMap",ref:p,id:"main",".animationOptions":g,".center":q(u),".zoom":q(d),".layers":c.value,".controls":s},[z("eox-map-tooltip",{style:W(f.value),".propertyTransform":O("main")},null,44,Ce)],40,xe),z("eox-map",{class:"fill-height fill-width overflow-none",id:"compare",slot:"second",ref_key:"compareMap",ref:i,".layers":t.value},[z("eox-map-tooltip",{style:W(M.value),".propertyTransform":O("compare")},null,44,we)],40,be)],40,he))}};export{Ae as default};
