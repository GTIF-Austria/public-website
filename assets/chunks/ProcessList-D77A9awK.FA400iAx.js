import{a as R,ag as B,V as v,b5 as $,b6 as E,b7 as I,b8 as J,b9 as N,ba as D,bb as w,r as U,t as F,z as G,aF as M,w as V,l as z,a$ as A,j as O,G as H,aw as W,aA as K,J as q,F as Q}from"./eo-dash.CkeGKxSi.js";import{g as X}from"./utils.KQWJcE3U.js";import{T as x}from"./index-E5db7hbd.CAYho6Sq.js";import{p as Y,am as Z,c as m,o as h,b as j,e as S,k as u,w as ee,j as d,F as te,B as se,t as P,at as k,G as y}from"./framework.CKdxjOfV.js";import"./commonjsHelpers.BosuxZz1.js";import"./index.KH_2m63C.js";import"./VTooltip-BLfbz10T.D-9SzN4U.js";import"./VOverlay-W0ueRY_c.B7o4E9ZM.js";import"./forwardRefs-HucV9l1e.DX9qO5e3.js";import"./transition-B4FivH1x.B3Ku8fBe.js";function Oe(e){return Object.keys((e==null?void 0:e.properties)??{}).find(a=>(e==null?void 0:e.properties[a].format)==="bounding-box")}function oe(e){return Object.keys((e==null?void 0:e.properties)??{}).filter(a=>(e==null?void 0:e.properties[a].type)==="geojson")}function Pe(e,a){const o=oe(a);for(const t of o)e[t]&&(X(a==null?void 0:a.properties[t])?e[t]=e[t].features.map(s=>JSON.stringify(s.geometry)):e[t]=JSON.stringify(e[t].geometry))}async function ae(e,a,o,t,s){let r=null;"eox:flatstyle"in(e??{})&&(r=await J.get(e["eox:flatstyle"]).then(l=>l.data));let i,n;if(r){const l=N(a??"",r);i=l.layerConfig,n=l.style}o=o.sort();const c=o.length>0?{type:"WebGLTile",source:{type:"GeoTIFF",normalize:!n,sources:o.map(l=>({url:l}))},properties:{id:e.id+"_process"+s,title:"Results "+a,...i&&{layerConfig:i},layerControlToolsExpand:!0},...n&&{style:n}}:void 0;return t&&c&&(c.source.projection=t),c}const re=(e,a)=>{if(!a)return;let o=a;if(typeof a=="object"){a=JSON.stringify(a);const s=new Blob([a],{type:"text"});o=URL.createObjectURL(s)}const t=document.createElement("a");confirm(`Would you like to download ${e}?`)&&(t.href=o,t.download=e,t.click()),URL.revokeObjectURL(o),t.remove()};function Ce(e,a,o){let t="",s="";[t,s]=a??["",""];const[r,i]=e??["",""];try{if(t&&s?(t=new Date(t),s=new Date(s)):(t=new Date(r),s=new Date(i)),(t<new Date(r)||t>new Date(i))&&(console.warn("[eodash] warn: start date is outside of the collection temporal extent and will be clamped",`
provided start date:${t.toISOString()}`,`
collection start date:${r}`),t=new Date(r)),(s>new Date(i)||s<new Date(r))&&(console.warn("[eodash] warn: end date is outside of the collection temporal extent and will be clamped",`
provided end date:${s.toISOString()}`,`
collection end date:${i}`),s=new Date(i)),t>s)return console.error("[eodash] Error: start date is greater than end date",t,s),[]}catch(f){return console.error("[eodash] Invalid date:",f.message),[]}const n=t.toISOString(),c=s.toISOString();if(!n||!c)return[];const l=[];let p=new Date(c);const C=new Date(n),g=24*60*60*1e3,L=o==="daily"?g:o==="weekly"?g*7:o==="monthly"?g*30:o==="yearly"?g*365:g;for(;p>=C&&l.length<31;)l.push(new Date(p)),p.setTime(p.getTime()-L);const T=[];for(let f=0;f<l.length-1;f++)T.push([l[f].toISOString(),l[f+1].toISOString()]);return T}function Le(e,a,o){if(!e)return[[],[]];const t=[],s=[];for(const r of e){const i=r.rel===a,n=o?r.type===o:!0;i&&n&&(r.endpoint?s.push(r):t.push(r))}return[t,s]}const b=Y([]);async function Re({processUrl:e,isPolling:a,pollInterval:o=1e4,maxRetries:t=560}){let s=0;for(a.value=!0,setTimeout(()=>{_(b,w)},500);s<t&&a.value;){try{const r=new Date().getTime(),n=(await D.get(`${e}?t=${r}`)).data;if(n.status==="successful"){console.log("Process completed successfully. Fetching result item...");const c=n.links[1].href;if(!c)throw new Error("Result links not found in the process report.");const l=await D.get(c);return console.log("Result file fetched successfully:",l.data),l.data}if(n.status==="failed")throw a.value=!1,new Error("Process failed.",n);console.log(`Status: ${n.status}. Retrying in ${o/1e3} seconds...`)}catch(r){r instanceof Error?console.error("Error while polling process status:",r.message):console.error("Unknown error occurred:",r)}await new Promise(r=>setTimeout(r,o)),s++}if(!a.value)return console.warn("Polling was stopped before the process was completed."),JSON.parse("{}");throw new Error("Max retries reached. Process did not complete successfully.")}async function _(e,a){const o=JSON.parse(localStorage.getItem(a.value)||"[]"),t=await Promise.all(o.map(s=>fetch(s).then(r=>r.json())));t.sort((s,r)=>new Date(r.job_start_datetime).getTime()-new Date(s.job_start_datetime).getTime()),e.value=t}const ne=async e=>{const o=JSON.parse(localStorage.getItem(w.value)||"[]").filter(t=>!t.includes(e.jobID));localStorage.setItem(w.value,JSON.stringify(o)),_(b,w)},ie=async(e,a)=>{const o=[];await fetch(e.links[1].href).then(t=>t.json()).then(t=>{o.push(...t.urls)}),o.forEach(t=>{if(!t)return;let s="";typeof t=="string"?(s=t.includes("/")?t.split("/").pop()??"":t,s=s.includes("?")?s.split("?")[0]:s):s=(a==null?void 0:a.id)+"_process_results.json",re(s,t)})},le=async(e,a)=>{const o=[];await D.get(e.links[1].href).then(t=>o.push(t.data)),await ce({selectedStac:a,results:o,jobId:e.jobID})};async function ce({selectedStac:e,results:a,jobId:o}){var r;const t=e==null?void 0:e.links.filter(i=>i.rel==="service"&&i.type==="image/tiff"),s=await ae(t==null?void 0:t[0],(e==null?void 0:e.id)??"",a==null?void 0:a[0].urls,((r=e==null?void 0:e["eodash:mapProjection"])==null?void 0:r.name)??null,o);if(z.debug("rendered layers after loading previous process:",s),s){const i=[...s?[s]:[]];let n=[...A()],c=n.find(l=>{var p;return(p=l.properties)==null?void 0:p.id.includes("AnalysisGroup")});c==null||c.layers.push(...i),O.value&&(O.value.layers=[...n])}}const de=F({fixedHeader:Boolean,fixedFooter:Boolean,height:[Number,String],hover:Boolean,...q(),...K(),...W(),...H()},"VTable"),ue=U()({name:"VTable",props:de(),setup(e,a){let{slots:o,emit:t}=a;const{themeClasses:s}=G(e),{densityClasses:r}=M(e);return V(()=>y(e.tag,{class:["v-table",{"v-table--fixed-height":!!e.height,"v-table--fixed-header":e.fixedHeader,"v-table--fixed-footer":e.fixedFooter,"v-table--has-top":!!o.top,"v-table--has-bottom":!!o.bottom,"v-table--hover":e.hover},s.value,r.value,e.class],style:e.style},{default:()=>{var i,n,c;return[(i=o.top)==null?void 0:i.call(o),o.default?y("div",{class:"v-table__wrapper",style:{height:Q(e.height)}},[y("table",null,[o.default()])]):(n=o.wrapper)==null?void 0:n.call(o),(c=o.bottom)==null?void 0:c.call(o)]}})),{}}}),pe={style:{padding:"0px"}},fe={style:{padding:"0px"}},ye={style:{padding:"0px"}},ge={__name:"ProcessList",setup(e){const{selectedStac:a}=Z(R());return B(()=>_(b,w)),(o,t)=>(h(),m("div",null,[u(b).length?(h(),j(ue,{key:0,density:"compact",style:{"background-color":"transparent"}},{default:ee(()=>[t[0]||(t[0]=d("thead",null,[d("tr",null,[d("th",{class:"text-left"},"Executed on"),d("th",{class:"text-left"},"Status"),d("th",{class:"text-left"}),d("th",{class:"text-left"}),d("th",{class:"text-left"})])],-1)),d("tbody",null,[(h(!0),m(te,null,se(u(b),s=>(h(),m("tr",{key:s.date},[d("td",null,P(new Date(s.job_start_datetime).toISOString().slice(0,16)),1),d("td",null,P(s.status),1),d("td",pe,[k(y(v,{disabled:s.status!=="successful",color:"primary",onClick:r=>u(le)(s,u(a)),icon:[u($)],variant:"text"},null,8,["disabled","onClick","icon"]),[[x,"Load results to map"]])]),d("td",fe,[k(y(v,{disabled:s.status!=="successful",color:"primary",onClick:r=>u(ie)(s,u(a)),icon:[u(E)],variant:"text"},null,8,["disabled","onClick","icon"]),[[x,"Download results"]])]),d("td",ye,[k(y(v,{color:"#ff5252",onClick:r=>u(ne)(s),icon:[u(I)],variant:"text"},null,8,["onClick","icon"]),[[x,"Remove job"]])])]))),128))])]),_:1})):S("v-if",!0)]))}},Be=Object.freeze(Object.defineProperty({__proto__:null,default:ge},Symbol.toStringTag,{value:"Module"}));export{Be as P,ge as _,Ce as a,ae as c,re as d,Pe as e,Oe as g,b as j,Re as p,Le as s,_ as u};
