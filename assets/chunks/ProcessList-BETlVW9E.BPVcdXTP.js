import{a as R,D as B,V as v,b5 as $,b6 as E,b7 as I,b8 as J,b9 as N,ba as D,bb as b,W as U,X as F,a1 as G,aF as M,Z as V,l as A,a$ as W,j as O,a9 as z,aw as H,aA as K,ab as X,a8 as Z}from"./eo-dash.DKFAp8AO.js";import{g as q}from"./utils.KQWJcE3U.js";import{T as x}from"./index-B93ct0BY.CAZM_9KF.js";import{p as Q,am as Y,c as m,o as h,b as j,e as S,k as u,w as ee,j as d,F as te,B as se,t as P,at as k,G as y}from"./framework._nxDF-kU.js";import"./commonjsHelpers.BosuxZz1.js";import"./index.KH_2m63C.js";import"./VTooltip-D8t32lZW.Bsg5uBUR.js";import"./VOverlay-C7O-NuKh.DE7_Qcd3.js";import"./forwardRefs-CFXBdNVg.Bk2tfxa5.js";import"./transition-BFRqNE2F.DnzJVbnS.js";function Oe(e){return Object.keys((e==null?void 0:e.properties)??{}).find(o=>(e==null?void 0:e.properties[o].format)==="bounding-box")}function ae(e){return Object.keys((e==null?void 0:e.properties)??{}).filter(o=>(e==null?void 0:e.properties[o].type)==="geojson")}function Pe(e,o){const a=ae(o);for(const t of a)e[t]&&(q(o==null?void 0:o.properties[t])?e[t]=e[t].features.map(s=>JSON.stringify(s.geometry)):e[t]=JSON.stringify(e[t].geometry))}async function oe(e,o,a,t,s){let r=null;"eox:flatstyle"in(e??{})&&(r=await J.get(e["eox:flatstyle"]).then(l=>l.data));let i,n;if(r){const l=N(o??"",r);i=l.layerConfig,n=l.style}a=a.sort();const c=a.length>0?{type:"WebGLTile",source:{type:"GeoTIFF",normalize:!n,sources:a.map(l=>({url:l}))},properties:{id:e.id+"_process"+s,title:"Results "+o,...i&&{layerConfig:i},layerControlToolsExpand:!0},...n&&{style:n}}:void 0;return t&&c&&(c.source.projection=t),c}const re=(e,o)=>{if(!o)return;let a=o;if(typeof o=="object"){o=JSON.stringify(o);const s=new Blob([o],{type:"text"});a=URL.createObjectURL(s)}const t=document.createElement("a");confirm(`Would you like to download ${e}?`)&&(t.href=a,t.download=e,t.click()),URL.revokeObjectURL(a),t.remove()};function Ce(e,o,a){let t="",s="";[t,s]=o??["",""];const[r,i]=e??["",""];try{if(t&&s?(t=new Date(t),s=new Date(s)):(t=new Date(r),s=new Date(i)),(t<new Date(r)||t>new Date(i))&&(console.warn("[eodash] warn: start date is outside of the collection temporal extent and will be clamped",`
provided start date:${t.toISOString()}`,`
collection start date:${r}`),t=new Date(r)),(s>new Date(i)||s<new Date(r))&&(console.warn("[eodash] warn: end date is outside of the collection temporal extent and will be clamped",`
provided end date:${s.toISOString()}`,`
collection end date:${i}`),s=new Date(i)),t>s)return console.error("[eodash] Error: start date is greater than end date",t,s),[]}catch(f){return console.error("[eodash] Invalid date:",f.message),[]}const n=t.toISOString(),c=s.toISOString();if(!n||!c)return[];const l=[];let p=new Date(c);const C=new Date(n),g=24*60*60*1e3,L=a==="daily"?g:a==="weekly"?g*7:a==="monthly"?g*30:a==="yearly"?g*365:g;for(;p>=C&&l.length<31;)l.push(new Date(p)),p.setTime(p.getTime()-L);const T=[];for(let f=0;f<l.length-1;f++)T.push([l[f].toISOString(),l[f+1].toISOString()]);return T}function Le(e,o,a){if(!e)return[[],[]];const t=[],s=[];for(const r of e){const i=r.rel===o,n=a?r.type===a:!0;i&&n&&(r.endpoint?s.push(r):t.push(r))}return[t,s]}const w=Q([]);async function Re({processUrl:e,isPolling:o,pollInterval:a=1e4,maxRetries:t=560}){let s=0;for(o.value=!0,setTimeout(()=>{_(w,b)},500);s<t&&o.value;){try{const r=new Date().getTime(),n=(await D.get(`${e}?t=${r}`)).data;if(n.status==="successful"){console.log("Process completed successfully. Fetching result item...");const c=n.links[1].href;if(!c)throw new Error("Result links not found in the process report.");const l=await D.get(c);return console.log("Result file fetched successfully:",l.data),l.data}if(n.status==="failed")throw o.value=!1,new Error("Process failed.",n);console.log(`Status: ${n.status}. Retrying in ${a/1e3} seconds...`)}catch(r){r instanceof Error?console.error("Error while polling process status:",r.message):console.error("Unknown error occurred:",r)}await new Promise(r=>setTimeout(r,a)),s++}if(!o.value)return console.warn("Polling was stopped before the process was completed."),JSON.parse("{}");throw new Error("Max retries reached. Process did not complete successfully.")}async function _(e,o){const a=JSON.parse(localStorage.getItem(o.value)||"[]"),t=await Promise.all(a.map(s=>fetch(s).then(r=>r.json())));t.sort((s,r)=>new Date(r.job_start_datetime).getTime()-new Date(s.job_start_datetime).getTime()),e.value=t}const ne=async e=>{const a=JSON.parse(localStorage.getItem(b.value)||"[]").filter(t=>!t.includes(e.jobID));localStorage.setItem(b.value,JSON.stringify(a)),_(w,b)},ie=async(e,o)=>{const a=[];await fetch(e.links[1].href).then(t=>t.json()).then(t=>{a.push(...t.urls)}),a.forEach(t=>{if(!t)return;let s="";typeof t=="string"?(s=t.includes("/")?t.split("/").pop()??"":t,s=s.includes("?")?s.split("?")[0]:s):s=(o==null?void 0:o.id)+"_process_results.json",re(s,t)})},le=async(e,o)=>{const a=[];await D.get(e.links[1].href).then(t=>a.push(t.data)),await ce({selectedStac:o,results:a,jobId:e.jobID})};async function ce({selectedStac:e,results:o,jobId:a}){var r;const t=e==null?void 0:e.links.filter(i=>i.rel==="service"&&i.type==="image/tiff"),s=await oe(t==null?void 0:t[0],(e==null?void 0:e.id)??"",o==null?void 0:o[0].urls,((r=e==null?void 0:e["eodash:mapProjection"])==null?void 0:r.name)??null,a);if(A.debug("rendered layers after loading previous process:",s),s){const i=[...s?[s]:[]];let n=[...W()],c=n.find(l=>{var p;return(p=l.properties)==null?void 0:p.id.includes("AnalysisGroup")});c==null||c.layers.push(...i),O.value&&(O.value.layers=[...n])}}const de=F({fixedHeader:Boolean,fixedFooter:Boolean,height:[Number,String],hover:Boolean,...X(),...K(),...H(),...z()},"VTable"),ue=U()({name:"VTable",props:de(),setup(e,o){let{slots:a,emit:t}=o;const{themeClasses:s}=G(e),{densityClasses:r}=M(e);return V(()=>y(e.tag,{class:["v-table",{"v-table--fixed-height":!!e.height,"v-table--fixed-header":e.fixedHeader,"v-table--fixed-footer":e.fixedFooter,"v-table--has-top":!!a.top,"v-table--has-bottom":!!a.bottom,"v-table--hover":e.hover},s.value,r.value,e.class],style:e.style},{default:()=>{var i,n,c;return[(i=a.top)==null?void 0:i.call(a),a.default?y("div",{class:"v-table__wrapper",style:{height:Z(e.height)}},[y("table",null,[a.default()])]):(n=a.wrapper)==null?void 0:n.call(a),(c=a.bottom)==null?void 0:c.call(a)]}})),{}}}),pe={style:{padding:"0px"}},fe={style:{padding:"0px"}},ye={style:{padding:"0px"}},ge={__name:"ProcessList",setup(e){const{selectedStac:o}=Y(R());return B(()=>_(w,b)),(a,t)=>(h(),m("div",null,[u(w).length?(h(),j(ue,{key:0,density:"compact",style:{"background-color":"transparent"}},{default:ee(()=>[t[0]||(t[0]=d("thead",null,[d("tr",null,[d("th",{class:"text-left"},"Executed on"),d("th",{class:"text-left"},"Status"),d("th",{class:"text-left"}),d("th",{class:"text-left"}),d("th",{class:"text-left"})])],-1)),d("tbody",null,[(h(!0),m(te,null,se(u(w),s=>(h(),m("tr",{key:s.date},[d("td",null,P(new Date(s.job_start_datetime).toISOString().slice(0,16)),1),d("td",null,P(s.status),1),d("td",pe,[k(y(v,{disabled:s.status!=="successful",color:"primary",onClick:r=>u(le)(s,u(o)),icon:[u($)],variant:"text"},null,8,["disabled","onClick","icon"]),[[x,"Load results to map"]])]),d("td",fe,[k(y(v,{disabled:s.status!=="successful",color:"primary",onClick:r=>u(ie)(s,u(o)),icon:[u(E)],variant:"text"},null,8,["disabled","onClick","icon"]),[[x,"Download results"]])]),d("td",ye,[k(y(v,{color:"#ff5252",onClick:r=>u(ne)(s),icon:[u(I)],variant:"text"},null,8,["onClick","icon"]),[[x,"Remove job"]])])]))),128))])]),_:1})):S("v-if",!0)]))}},Be=Object.freeze(Object.defineProperty({__proto__:null,default:ge},Symbol.toStringTag,{value:"Module"}));export{Be as P,ge as _,Ce as a,oe as c,re as d,Pe as e,Oe as g,w as j,Re as p,Le as s,_ as u};
