import{d as $,aU as k,a as _,aV as U,af as N,aW as T,ae as z,aX as g,l as G,a2 as w,W as D,aY as K,aZ as H,a_ as F,a$ as M,g as Q}from"./eo-dash.CbtluJu3.js";import{u as V,g as S,e as X,a as Y,s as I,c as Z,p as j,b as ee,d as J,f as te,h as ae}from"./async-DecDcV2x.B_3ysxTr.js";import{t as re}from"./item.koN_VtZd.js";async function ne({links:e,jsonformValue:r,specUrl:n,customEndpointsHandler:t,jsonformSchema:a,selectedStac:o,isPolling:u,jobs:c,enableCompare:i=!1}){if(!n||!e)return[null,null];const l=await g.get(n).then(p=>p.data),s={},[d,f]=I(e,"service",void 0),h=t&&r&&await t({jsonformSchema:a,jsonformValue:r,links:f,selectedStac:o,isPolling:u,jobs:c,enableCompare:i});if(h&&h.length)return l.data.values=h,[l,s];const v=d.filter(p=>p.rel==="service");try{e:for(const p of v??[])switch(p.type){case void 0:continue;case"application/json":await oe(l,{url:p.href,jsonformValue:r,link:p,flatstyleUrl:p["eox:flatstyle"],jsonformSchema:a});break e;case"text/csv":await se(l,{url:p.href,jsonformValue:r,flatstyleUrl:p["eox:flatstyle"]});break e}}catch(p){console.error("[eodash] Error while injecting Vega data",p)}return[l,s]}async function oe(e,{url:r,jsonformValue:n,link:t,flatstyleUrl:a,jsonformSchema:o}){var u;if(e.data){if(t.method=="GET"){const c=(u=o==null?void 0:o.options)==null?void 0:u.multiQuery,i=Object.keys(n??{}).filter(s=>Array.isArray(c)?c.includes(s):c===s);if(i.length>0&&n){const s=[];for(const d of i)if(Array.isArray(n[d]))for(const f of n[d]){const h=await P(r,{...n,[d]:f},a);s.push(await g.get(h).then(v=>v.data))}else{const f=await P(r,n,a);s.push(await g.get(f).then(h=>h.data))}return e.data.values=s.flat(),e}const l=await P(r,n,a);e.data.values=await g.get(l).then(s=>s.data)}else if(t.method=="POST"){if(!t.body)return console.error("[eodash] Inline data POST request requires a body template"),e;const c=await g.get(t.body,{responseType:"text"}).then(l=>l.data),i=JSON.parse(w.render(c,{...n??{}}));e.data.values=await g.post(r,i).then(l=>l.data)}return e}}async function se(e,{url:r,jsonformValue:n,flatstyleUrl:t}){if(!e.data)return;const a=await P(r,n,t);return e.data.url=a,e}async function P(e,r,n){let t={};return n&&(t=await g.get(n).then(a=>a.data)),w.render(e,{...r??{},...t})}async function ie({links:e,jsonformValue:r,layerId:n,projection:t}){if(!e)return;const[a,o]=I(e,"service","image/tiff");if(!a.length)return;let u=[],c="";for(const l of a??[])u.push(w.render(l.href,{...r??{}}));return await Promise.all(a.map(l=>Z(l,n,u,t,c))).then(l=>l.filter(s=>!!s))}function le(e,r,n){if(!e)return;const t=e.filter(o=>o.rel==="service"&&o.type==="image/png"),a=[];for(const o of t)a.push({type:"Image",properties:{id:o.id+"_process",title:"Results "+o.id},source:{type:"ImageStatic",imageExtent:n,url:w.render(o.href,{...r??{}})}});return a}async function ce(e,r,n){if(!e)return;const t=[],a=e.filter(u=>u.rel==="service"&&u.type==="application/geo+json");if(!a.length)return t;let o=null;for(const u of a){"eox:flatstyle"in(u??{})&&(o=await g.get(u["eox:flatstyle"]).then(s=>s.data));let c,i;if(o){const s=K(n??"",o);c=s.layerConfig,i=s.style}const l={type:"Vector",source:{type:"Vector",url:w.render(u.href,{...r??{}}),format:"GeoJSON"},properties:{id:u.id+"_process",title:"Results "+n,...c&&{...c}},...i&&{style:i}};t.push(l)}return t}async function ue({links:e,jsonformValue:r,layerId:n,projection:t,origBbox:a,isPolling:o,selectedStac:u,jsonformSchema:c,jobs:i,customLayersHandler:l,enableCompare:s=!1}){if(!e)return[];const d=[],[f,h]=I(e,"service",void 0);if(l&&r&&u&&c&&h.length>0){const m=await l({jsonformValue:r,links:h,selectedStac:u,isPolling:o,jsonformSchema:c,jobs:i,enableCompare:s});m.length&&d.push(...m)}const v=await ce(f,r,n),p=le(f,r,a),C=await ie({links:f,jsonformValue:r,layerId:n,projection:t});return d.push(...v??[],...p??[],...C??[]),d}async function de(e,r,n=!1){const t=e.find(c=>c.rel==="service"&&c.type=="application/json; profile=collection"&&c.endpoint==="STAC");if(!t)return;let a=w.render(t.href,{...r??{}});D.value&&(D.value=!1);const o=_();await(n?o.loadSelectedCompareSTAC:o.loadSelectedSTAC)(a,!0)}async function fe({links:e,jsonformValue:r,isPolling:n,selectedStac:t,jobs:a,enableCompare:o=!1}){if(!n)return;const u=e.filter(i=>i.rel==="service"&&i.endpoint==="eoxhub_workspaces"),c=[];for(const i of u){const l=await g.get(i.body,{responseType:"text"}).then(f=>f.data),s=JSON.parse(w.render(l,{...r??{}})),d=o?T:k;try{const f=await g.post(i.href,s,{headers:{"Content-Type":"application/json"}}),h=JSON.parse(localStorage.getItem(d.value)||"[]");h.push(f.headers.location),localStorage.setItem(d.value,JSON.stringify(h));const v=await j({jobs:a,processUrl:f.headers.location,isPolling:n,enableCompare:o}).then(p=>ee(p)).catch(p=>(p instanceof Error?console.error("Polling failed:",p.message):console.error("Unknown error occurred during polling:",p),[]));await J(a,d.value),c.push(...await te(v,i,t))}catch(f){await J(a,d.value),f instanceof Error?console.error("Error sending POST request:",f.message):console.error("Unknown error occurred:",f)}}return c}const he=pe([fe]);function pe(e){return async r=>await Promise.all(e.map(n=>n(r))).then(n=>{const t=[];for(const a of n)t.push(...(a==null?void 0:a.filter(ge))??[]);return t})}function ge(e){return!!e&&!!e.type&&(!!e.source||!!e.layers)}async function ve({links:e,jsonformValue:r,jsonformSchema:n,selectedStac:t,enableCompare:a=!1}){const o=e.find(f=>f.rel==="service"&&f.endpoint==="sentinelhub");if(!o)return;const u=await be(t,a?H.value:F.value);if(!u){console.error("[eodash] evalscript link for sentinel hub not found in indicator",u);return}if(!o)return;const c=o.href,i=S(n),l=r[i],s=await ye();if(!s){console.error("[eodash] Error while fetching bearer token from sentinel hub");return}const d=ae(t.extent.temporal.interval[0],[r.start_date,r.end_date],r.distribution);return await Promise.all(d.map(([f,h])=>we({url:c,bearer:s,bbox:l,from:h,to:f,exampleLink:u}).catch(v=>console.error("[eodash] Error while fetching data from sentinel hub endpoint:",v)))).then(f=>f.flat().map(h=>h.outputs.data))}async function ye(e,r){{console.error("[eodash] Error (sentinelhub): client id or secret not found");return}}async function we({url:e,bearer:r,bbox:n,from:t,to:a,timeout:o=2e4,exampleLink:u}){if(!u){console.error("[eodash] Error (sentinelhub): example link not found in indicator");return}if(!n){console.error("[eodash] Error (sentinelhub): bbox not found");return}if(!t||!a||new Date(t)>new Date(a)){console.error("[eodash] Error (sentinelhub): time range is faulty or not found",t,a);return}const c=await g.get(u.href,{responseType:"text"}).then(s=>s.data);if(!c||c.error){console.error("[eodash] Error (sentinelhub): evalscript not found",c);return}const i={input:{bounds:{bbox:n},data:[{dataFilter:{},type:u.dataId}]},aggregation:{evalscript:c,timeRange:{from:t,to:a},aggregationInterval:{of:"P1D"},width:100,height:100},calculations:{default:{}}},l={headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"},params:{credentials:"same-origin"},timeout:o};return await g.post(e,i,l).then(s=>{const d=s.data.data;return d.forEach(f=>{f.outputs.data.date=t}),d}).catch(s=>{var d,f;if(((d=s.response)==null?void 0:d.status)===401){console.error("[eodash] Error (sentinelhub): bearer token expired, please try again"),sessionStorage.removeItem("sentinelhub_token"),sessionStorage.removeItem("sentinelhub_token_time");return}return console.error("[eodash] Error (sentinelhub): error while fetching data from sentinel hub",(f=s.response)==null?void 0:f.data),[]})}async function be(e,r){const n=e.links.find(t=>t.rel==="example"&&t.title==="evalscript");if(n)return n;for(const t of M(e,r)){const a=g.get(t).then(o=>o.data.links.find(u=>u.rel==="example"&&u.title==="evalscript"));if(a)return a}}async function me({links:e,jsonformSchema:r,jsonformValue:n,selectedStac:t,enableCompare:a=!1}){const o=e.find(s=>s.rel==="service"&&s.endpoint==="veda");if(!o)return;const u=o==null?void 0:o.href,c=S(r),i=JSON.parse(n[c]),l=await xe(t,a?H.value:F.value);return await Promise.all(l.map(({endpoint:s,datetime:d})=>g.post(u+`?url=${s}`,{type:"Feature",properties:{},geometry:i}).then(f=>{const h=f.data.properties.statistics;return h.date=d,h}).catch(f=>console.error("[eodash] Error while fetching data from veda endpoint:",f))))}async function xe(e,r){const n=e.links.filter(i=>i.rel=="child"),t=[];n.length?t.push(...await Promise.all(n.map(i=>g.get(re(i.href,r)).then(l=>l.data)))):t.push(e);const a=[];for(const i of t){const l=Q(i.links);let s=i.links.filter(d=>d.rel=="item");a.push(...s.map(d=>({endpoint:d.cog_href,datetime:d[l]})))}a.sort((i,l)=>new Date(i.datetime).getTime()-new Date(l.datetime).getTime());const o=50;if(a.length<=o)return a;const u=a.length,c=[];for(let i=0;i<o;i++){const l=Math.floor(i*(u-1)/(o-1));c.push(a[l])}return c}const Ce=ke([ve,me]);function ke(e){return async r=>{for(const n of e){const t=await n(r);if(G.debug("Custom endpoint data:",t,"for callback:",n.name,"inputs:",r),!(!t||!t.length||t.some(o=>!o)))return t}return null}}async function Ie({selectedStac:e,jsonformEl:r,jsonformSchema:n,chartSpec:t,isProcessed:a,processResults:o,loading:u,isPolling:c,enableCompare:i}){var d,f;const l=i?!!N.value:!!z.value;let s=null;if((d=e.value)!=null&&d["eodash:jsonform"]&&(s=await g.get(e.value["eodash:jsonform"]).then(h=>h.data)),!s&&l){n.value=null;return}Pe({loading:u,isProcessed:a,chartSpec:t,jsonformSchema:n,isPolling:c,processResults:o}),await((f=r.value)==null?void 0:f.editor.destroy()),s&&(i&&(s=V(s)),n.value=s)}async function Oe({loading:e,selectedStac:r,jsonformEl:n,jsonformSchema:t,chartSpec:a,chartData:o,isPolling:u,processResults:c,mapElement:i,jobs:l}){var s,d,f,h,v,p,C,m,O,A,E;if(!(!n.value||!t.value||!r.value)){G.debug("Processing..."),e.value=!0;try{const b=(d=(s=r.value)==null?void 0:s.links)==null?void 0:d.filter(y=>y.rel==="service"),B=S(t.value),x=(f=n.value)==null?void 0:f.value;X(x,t.value);const q=x[B],R=(h=r.value)==null?void 0:h["eodash:vegadefinition"],W=((v=r.value)==null?void 0:v.id)??"";[a.value,o.value]=await ne({links:b,jsonformValue:{...x??{}},jsonformSchema:t.value,enableCompare:(i==null?void 0:i.id)==="compare",selectedStac:r.value,specUrl:R,isPolling:u,jobs:l,customEndpointsHandler:Ce}),Object.keys(o.value??{}).length&&c.value.push(o.value),(m=(C=(p=a.value)==null?void 0:p.data)==null?void 0:C.values)!=null&&m.length&&c.value.push((O=a.value)==null?void 0:O.data.values),a.value&&!("background"in a.value)&&(a.value.background="transparent"),await de(b,x,(i==null?void 0:i.id)==="compare");const L=await ue({isPolling:u,links:b,jsonformValue:{...x??{}},jsonformSchema:t.value,selectedStac:r.value,enableCompare:(i==null?void 0:i.id)==="compare",layerId:W,origBbox:q,jobs:l,customLayersHandler:he,projection:(A=r.value["eodash:mapProjection"])==null?void 0:A.name});if(L.length)for(const y of L)y.type==="WebGLTile"&&((E=y.source)==null?void 0:E.type)==="GeoTIFF"?c.value.push(...y.source.sources??[]):y.source&&"url"in y.source&&c.value.push(y.source.url);Y(i,L),e.value=!1}catch(b){throw console.error("[eodash] Error while running process:",b),e.value=!1,b}}}function Pe({loading:e,isProcessed:r,chartSpec:n,jsonformSchema:t,processResults:a,isPolling:o}){e.value=!1,r.value=!1,o.value=!1,n.value=null,a.value=[],t.value=null}const Ae=e=>{var a,o,u,c,i,l;const r=(a=e.target)==null?void 0:a.spec;if(!r||!((u=(o=e.detail)==null?void 0:o.item)!=null&&u.datum)||!((i=(c=e.detail)==null?void 0:c.item)!=null&&i.datum.datum))return;const n=Object.keys(r.encoding??{}).find(s=>{var d;return((d=r.encoding)==null?void 0:d[s].type)==="temporal"});if(!n)return;const t=(l=r.encoding)==null?void 0:l[n].field;if(t)try{const s=e.detail.item;let d="";s.datum&&s.datum.datum?d=s.datum.datum[t]:d=s.datum[t];const f=new Date(d);$.value=f.toISOString()}catch(s){console.warn("[eodash] Error while setting datetime from eox-chart:",s)}},Ee=()=>{var n,t;k.value||(k.value=new URLSearchParams(window.location.search).get("indicator")??"");const e=_(),r=(n=e.stac)==null?void 0:n.find(a=>U(a)===k.value);if(e.loadSelectedSTAC(r==null?void 0:r.href),N.value)if(T.value){const a=(t=e.stac)==null?void 0:t.find(o=>U(o)===T.value);e.loadSelectedCompareSTAC(a==null?void 0:a.href).catch(o=>{console.error("[eodash] Error loading compare STAC:",o)})}else e.resetSelectedCompareSTAC()};export{Oe as h,Ie as i,Ee as l,Ae as o};
